<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

    <ui:composition template="/WEB-INF/templates/layout.xhtml">
        <ui:param name="title" value="Users"></ui:param>
        <ui:param name="path" value="/"></ui:param>
        <ui:define name = "content">
            <main xmlns="http://www.w3.org/1999/xhtml" tabindex="-1" role="main" id="content" class="bs-docs-masthead">
                <div class="container">
                    <c:set var="collUser" value="#{userService.getUser(param['user'])}" scope="request" />
                    <h1><h:outputText value="#{collUser.name}"/></h1>

                    <img class="align-self-center mr-3 media-img canvas_thum" style="margin: 5px;" src="#{collUser.picture}"/>
                    <br/>
                    <br/>
                    <ul>
                        <li>
                            <b>Email</b>: 
                            <c:if test="#{not empty collUser.email}">
                                <a href="mailto:#{collUser.email}"><h:outputText value="#{collUser.email}"/></a>
                            </c:if>
                            <c:if test="#{empty collUser.email}">
                                Not provided
                            </c:if>
                        </li>
                        <li><b>Login method</b>: <h:outputText value="#{collUser.authenticationMethod}"/></li>
                        <li><b>Created</b>: <h:outputText value="#{collUser.created}"/></li>
                        <li><b>Modified</b>: <h:outputText value="#{collUser.lastModified}"/></li>
                    </ul>

                    <a href="users.xhtml" class="btn btn-danger mb-2" data-mode="delete_user" data-label="#{collUser.name}" data-url="#{collUser.id}" onclick="showConfirm(event); return false;"><i class="fas secondary"></i> Delete User</a>
                    <hr/>
                    <script src="/js/collection.js"></script>
                    <h2>Collections</h2>
                    <c:if test="#{empty storeService.getCollections(collUser)}">
                        <p>This user has no collections</p>
                    </c:if>
                    <c:forEach items="#{storeService.getCollections(collUser)}" var="collection" varStatus="iterMetadata">
                        <h3><h:outputText value="#{collection.label}"/></h3>
                        <ul class="media-list">
                            <c:forEach items="#{collection.manifests}" var="manifest" varStatus="iterMetadata">
                                <li class="manifestSummary" id="#{manifest.shortId}">
                                    <div class="media-header-div">
                                        <h3 class="box_type">   
                                            Manifest
                                        </h3>
                                    </div>
                                    <div class="media-heading">
                                        <c:set var="logo" value="#{manifest.logo}" scope="request" />
                                        <img id="logo-#{manifest.shortId}" class="logo" src="#{logo}"/>
                                        <h5>
                                            <c:if test="#{not empty manifest.label}">
                                                <h:outputText value="#{manifest.label}"/>
                                            </c:if>
                                            <c:if test="#{empty manifest.label}">
                                                Missing Manifest label
                                            </c:if>
                                        </h5>
                                    </div>
                                    <div class="media">
                                        <img id="thum-#{manifest.shortId}" src="" style="margin: 5px" class="align-self-center mr-3 media-img" />
                                        <div class="media-body">
                                            <a href="canvases.xhtml?manifest=#{manifest.URI}&amp;user=#{collUser.id}" class="btn btn-secondary mb-2"><i class="fas fa-eye"></i> Browse Annotations</a>

                                            <p><b>Number of annotated canvases: </b> <h:outputText value='#{storeService.countAnnotations(manifest).get("canvas_count")}'/></p>
                                            <p><b>Number of annotations: </b> <h:outputText value='#{storeService.countAnnotations(manifest).get("total_annos")}'/></p>
                                            <div id="actionBar">
                                                <span>
                                                    <a class="actionLink" href="/manifests/#{collUser.shortId}/#{manifest.shortId}.json" target="_blank">Manifest URL</a>
                                                    <a class="actionLink" href="/manifests/#{collUser.shortId}/#{manifest.shortId}.json" onclick="openViewer(this,'mirador')" target="_blank">View in Mirador</a>
                                                    <a class="actionLink" href="/manifests/#{collUser.shortId}/#{manifest.shortId}.json" onclick="openViewer(this,'uv')"  target="_blank">View in UV</a>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <script>
                                        populateManifest("#{manifest.URI}", "#{manifest.shortId}");
                                    </script>
                                </li>
                            </c:forEach>
                        </ul>
                </c:forEach>
                </div>

                <script>
                    function openViewer(link, type) {
                        let url = '';
                        if (type === "mirador") {
                            url = "https://projectmirador.org/embed/?iiif-content=";
                        } else {
                            url = "http://universalviewer.io/examples/#?c=&amp;m=&amp;s=&amp;cv=&amp;manifest=";
                        }
                        link.href = url + link.href;
                    }
                </script>

                <ui:include src="/WEB-INF/templates/dialogues/confirm.xhtml"/>
            </main>
        </ui:define>
    </ui:composition>
</html>
