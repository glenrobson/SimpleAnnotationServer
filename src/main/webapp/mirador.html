<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link rel="stylesheet" type="text/css" href="mirador-2.6.1/css/mirador-combined.css">
  <title>Mirador Viewer</title>
  <style type="text/css">
    body { padding: 0; margin: 0; overflow: hidden;}
    #viewer {width: 100%; height: 100%; position: fixed; }
  </style>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz" crossorigin="anonymous"/>
  <script src="js/sas.js"></script>
</head>
<body>
  <div id="viewer"></div>

  <script src="mirador-2.6.1/mirador.js"></script>
  <script type="text/javascript">

    $(function() {
        var configuration = {
            "id": "viewer",
            "layout": "1x1",
            "buildPath": "mirador-2.6.1/",
            "mainMenuSettings": {
                "show": true,
                "buttons" : {"bookmark" : false, "layout" : true},
            },
            'openManifestsPage' : true,
            'showAddFromURLBox' : true,
            "windowSettings": {
                "sidePanelVisible" : false,
            },
            "saveSession": false,
            annotationEndpoint: {
                name: 'Simple Annotation Store Endpoint',
                module: 'SimpleASEndpoint',
                options: {
                    url: 'annotation',
                }
            },
            "sidePanelOptions" : {
            "tocTabAvailable": true,
            "layersTabAvailable": true,
            "searchTabAvailable": true
            }
        };

        var manifest = getURLParameter("manifest");
        var collection = getURLParameter("collection");
        var canvas = getURLParameter("canvas");
        console.log("Manifest " + manifest + " collection: " + collection);
        var collectionAdded = false;
        if(typeof(collection) == "string" && collection.length > 0) {
            configuration.data = [{
                "collectionUri": collection,
                "location": "Local Manifests"
            }];
            collectionAdded = true;
        }
        if(typeof(manifest) == "string" && manifest.length > 0) {
            if (!collectionAdded) { 
                configuration.data = [{
                    "manifestUri": manifest,
                    "location": "Local Manifests"
                }];
            }
            configuration.windowObjects = [{
                "loadedManifest": manifest
            }];
            if (typeof(canvas) == "string" && canvas.length > 0) {
                configuration.windowObjects[0].canvasID = canvas;
            }
        }

        var mirador = Mirador(configuration);
        // Every time a manifest is loaded send it for indexing and 
        // add IIIF search service so you can search your annotations
        mirador.eventEmitter.subscribe('manifestReceived', function(event, newManifest) {
            $.ajax({
                url: '/manifests/',
                data: {
                    "collection": collection,
                    "manifest": newManifest.uri
                },
                type: 'GET',
                success: function(data) {
                    var json = data;
                    console.log("Search API for " + newManifest.uri + " avilable at: search-api/" + json.loaded.short_id + "/search");
                    newManifest.jsonLd['service'] = {
                        profile: 'http://iiif.io/api/search/0/search',
                        '@id': 'search-api/' + json.loaded.short_id + "/search",
                        '@context': 'http://iiif.io/api/search/0/context.json'
                    }
                },
                error: function(data) {
                    var json = data.responseJSON;
                    if (json.code === 404) {
                        // Now need to index the manifest
                        newManifest.jsonLd['within'] = collection;
                        $.ajax({
                            url: '/manifests/',
                            data: JSON.stringify(newManifest.jsonLd),
                            type: 'POST',
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            success: function(data) {
                                var json = data;
                                console.log("Search API for " + newManifest.uri + " avilable at: search-api/" + json.loaded.short_id + "/search");
                                newManifest.jsonLd['service'] = {
                                    profile: 'http://iiif.io/api/search/0/search',
                                    '@id': 'search-api/' + json.loaded.short_id + "/search",
                                    '@context': 'http://iiif.io/api/search/0/context.json'
                                }
                            },
                            error: function(data) {
                                console.log('Failed to load manifest: ' + data.responseJSON.message);
                            }
                        });
                    } else {
                        console.log('Failed to find manifest: ' + data.responseJSON.message);
                    }
                }
            });
        });
      });
      </script>
</body>
</html>
